<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>使用 React Context API 和 Hooks 实现全局状态管理和性能优化 | Sanonz</title><meta name="author" content="Sanonz"><meta name="keywords" content="Sanonz、Web、WebGL、Font End、Developer、Mini Program"><meta name="description" content="介绍我们知道 React.js 默认没有全局状态的概念，需要安装第三方库来实现，最早的是流行的是 Facebook 自己出的 Flux，因为 Flux 使用流程有点复杂，后来 Redux、MobX 就兴起了。Redux 是借鉴 Flux 开发的，它们都是单向数据流，而 MobX 则有所不同，它是基于观察者模式实现。虽然默认没有全局状态管理，但是也可以通过 Context 特性拼凑出来一个，那为啥以前没人拼凑一个出来用呢？那是因为 React.js 以前的 Context 不好用，也不稳定，官方不"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><link rel="alternate" href="/atom.xml" title="Sanonz" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><style type="text/css">@font-face{font-family:icomoon;src:url(/fonts/icomoon.eot?q628ml);src:url(/fonts/icomoon.eot?q628ml#iefix) format('embedded-opentype'),url(/fonts/icomoon.ttf?q628ml) format('truetype'),url(/fonts/icomoon.woff?q628ml) format('woff'),url(/fonts/icomoon.svg?q628ml#icomoon) format('svg');font-weight:400;font-style:normal}</style><link rel="stylesheet" href="/css/style.css"><!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]--><meta name="generator" content="Hexo 4.2.1"></head><body><main class="app"><header id="header" class="header clearfix"><div id="nav" class="nav"><div class="nav-mobile"><button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button><h1 class="nav-mobile-title nav-mobile-item">Sanonz</h1><button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button></div><nav id="nav-inner" class="nav-inner"><a class="nav-item" href="/"><span class="nav-text">首页</span> </a><a class="nav-item" href="/categories/front-end"><span class="nav-text">前端</span> </a><a class="nav-item" href="/categories/back-end"><span class="nav-text">后端</span> </a><a class="nav-item" href="/tags"><span class="nav-text">标签</span> </a><a class="nav-item" href="/archives"><span class="nav-text">归档</span> </a><a class="nav-item" href="/atom.xml"><span class="nav-text">订阅</span> </a><a class="nav-item" href="/about"><span class="nav-text">关于</span></a></nav></div><aside id="aside" class="aside"><div id="aside-mask" class="aside-mask"></div><div id="aside-inner" class="aside-inner"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="https://sanonz.github.io"></form><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现全局状态"><span class="toc-number">2.</span> <span class="toc-text">实现全局状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#useReducer-的简单使用"><span class="toc-number">2.1.</span> <span class="toc-text">useReducer 的简单使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#借助-Context-实现全局状态"><span class="toc-number">2.2.</span> <span class="toc-text">借助 Context 实现全局状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#全局状态优化"><span class="toc-number">3.</span> <span class="toc-text">全局状态优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#性能问题排查"><span class="toc-number">3.1.</span> <span class="toc-text">性能问题排查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#减少不必要的组件重绘"><span class="toc-number">3.2.</span> <span class="toc-text">减少不必要的组件重绘</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">4.</span> <span class="toc-text">小结</span></a></li></ol></div></aside></header><div id="content" class="content"><div id="wrapper" class="wrapper"><article class="article" itemscope itemprop="blogPost"><header class="article-header"><h1 itemprop="name">使用 React Context API 和 Hooks 实现全局状态管理和性能优化</h1><div class="article-meta clearfix"><a class="article-date" href="https://sanonz.github.io/2020/state-management-and-performance-optimization-for-react-context-api-with-hooks/index.html"><i class="icon-calendar vm"></i> <time class="vm" datetime="2020-09-09T11:22:35.000Z" itemprop="datePublished">2020-09-09</time></a><div class="article-tag-list"><i class="icon-tag vm"></i> <a class="article-tag-link" href="/tags/React-js/" rel="tag">React.js</a></div></div></header><section class="article-body markdown-body"><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>我们知道 React.js 默认没有全局状态的概念，需要安装第三方库来实现，最早的是流行的是 Facebook 自己出的 <a href="https://github.com/facebook/flux" target="_blank" rel="noopener">Flux</a>，因为 Flux 使用流程有点复杂，后来 <a href="https://github.com/reduxjs/redux" target="_blank" rel="noopener">Redux</a>、<a href="https://github.com/mobxjs/mobx" target="_blank" rel="noopener">MobX</a> 就兴起了。Redux 是借鉴 Flux 开发的，它们都是单向数据流，而 MobX 则有所不同，它是基于观察者模式实现。</p><p>虽然默认没有全局状态管理，但是也可以通过 <code>Context</code> 特性拼凑出来一个，那为啥以前没人拼凑一个出来用呢？那是因为 React.js 以前的 <code>Context</code> 不好用，也不稳定，官方不建议使用，所以一般是特殊情况非得用不可的时候才使用它，但是现在时过境迁，当初那个不成熟的 <code>Context</code> 现在已经变得强壮有力了。</p><p>在去年二月 React.js 发布了一个大的版本更新 <a href="https://github.com/facebook/react/blob/master/CHANGELOG.md#1680-february-6-2019" target="_blank" rel="noopener">v16.8.0</a> 加入了 hooks 功能，其中内置了 <code>useReducer()</code> hook，它是 <code>useState()</code> 的替代品，简单的状态可以直接使用 <code>useState</code>，当我们遇到复杂多层级的状态或者下个状态要依赖上个状态时使用 <code>useReducer()</code> 则非常方便，在配合 <code>Context</code> 与 <code>useContext()</code> 就能实现类似 Redux 库的功能。</p><a id="more"></a><h2 id="实现全局状态"><a href="#实现全局状态" class="headerlink" title="实现全局状态"></a>实现全局状态</h2><h3 id="useReducer-的简单使用"><a href="#useReducer-的简单使用" class="headerlink" title="useReducer 的简单使用"></a>useReducer 的简单使用</h3><p>这里借用了官方写的一个简单的示例，创建 <code>Counter.jsx</code> 文件。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;<span class="attr">count</span>: <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increment'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count + <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrement'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count - <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = useReducer(reducer, initialState);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      Count: &#123;state.count&#125;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; dispatch(&#123;<span class="attr">type</span>: <span class="string">'decrement'</span>&#125;)&#125;&gt;-&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; dispatch(&#123;type: 'increment'&#125;)&#125;&gt;+&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>这样就实现了一个简单的 redux 方式的状态管理器，目前这种只是替代 <code>useState()</code> 在组件中绑定使用的方式，下边将会介绍提升到全局作为全局状态来使用。</p><h3 id="借助-Context-实现全局状态"><a href="#借助-Context-实现全局状态" class="headerlink" title="借助 Context 实现全局状态"></a>借助 <code>Context</code> 实现全局状态</h3><p>创建 <code>store.jsx</code> 文件。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; createContext, useReducer, useContext &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;<span class="attr">count</span>: <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increment'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count + <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrement'</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123;<span class="attr">count</span>: state.count - <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Context = createContext();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useStore</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> useContext(Context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">StoreProvider</span>(<span class="params">&#123; children &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = useReducer(reducer, initialState);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Context.Provider value=&#123;[state, dispatch]&#125;&gt;</span><br><span class="line">      &#123;children&#125;</span><br><span class="line">    &lt;<span class="regexp">/Context.Provider&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export &#123; useStore, StoreProvider &#125;;</span></span><br></pre></td></tr></table></figure><p>创建 <code>Header.jsx</code> 文件，把更新状态的行为放到此组件中。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">'./store'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Header</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [<span class="comment">/* state */</span>, dispatch] = useStore();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'header udpate'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; dispatch(&#123;<span class="attr">type</span>: <span class="string">'decrement'</span>&#125;)&#125;&gt;-&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; dispatch(&#123;type: 'increment'&#125;)&#125;&gt;+&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Header;</span></span><br></pre></td></tr></table></figure><p>创建 <code>Footer.jsx</code> 文件，把引用全局计数状态的放到此组件中。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">'./store'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Footer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state] = useStore();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'footer udpate'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;p&gt;&#123;state.count&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Footer;</span></span><br></pre></td></tr></table></figure><p>创建 <code>App.jsx</code> 文件，用 <code>&lt;StoreProvider /&gt;</code> 组件包装 <code>&lt;Header /&gt;</code> 与 <code>&lt;Footer /&gt;</code> 组件。</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Header <span class="keyword">from</span> <span class="string">'./Header'</span>;</span><br><span class="line"><span class="keyword">import</span> Footer <span class="keyword">from</span> <span class="string">'./Footer'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; StoreProvider &#125; <span class="keyword">from</span> <span class="string">'./store'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;StoreProvider&gt;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Header /&gt;</span><br><span class="line">        &lt;Footer /&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>StoreProvider&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure><p>这样我们就实现了全局 Store，在需要使用全局状态的地方调用 <code>useStore()</code> 就可以使用状态以及更改状态。为了方便查看引用 <code>useStore()</code> hook 的组件的更新状况，我们把更新行为放到了 <code>&lt;Header /&gt;</code> 组件中，把引用计数的放到了 <code>&lt;Footer /&gt;</code> 组件中。这里放了一个演示窗口。</p><iframe src="https://codesandbox.io/embed/state-management-for-react-fk6jz?expanddevtools=1&fontsize=14&hidenavigation=1&theme=dark" width="100%" height="500" frameborder="0" loading="lazy" allowfullscreen></iframe><h2 id="全局状态优化"><a href="#全局状态优化" class="headerlink" title="全局状态优化"></a>全局状态优化</h2><h3 id="性能问题排查"><a href="#性能问题排查" class="headerlink" title="性能问题排查"></a>性能问题排查</h3><p>在上方演示中点击 <code>+</code> 按钮并注意控制台的打印，会有以下输出，其中前两个是组件初始化所打印的，后两个是我们点击 <code>+</code> 号按钮打印的，为了方便查看我在它们中间加了个换行，思考以下有什么性能问题呢？</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">header udpate</span><br><span class="line">footer udpate</span><br><span class="line"></span><br><span class="line">header udpate</span><br><span class="line">footer udpate</span><br></pre></td></tr></table></figure><p>在 <code>&lt;Header /&gt;</code> 组件中我们并没有使用 <code>state</code> 状态，只是使用了更新方法 <code>dispatch</code> 而已，但是当状态更新时 <code>&lt;Header /&gt;</code> 组件依然执行了重绘，当我们每次点击 <code>+</code>、<code>-</code> 按钮时 <code>&lt;Header /&gt;</code> 组件都会重绘，但是实际上这个重绘显然是不需要的。</p><p>在实际开发中，我们可能会在很多组件中使用 <code>const [, dispatch] = useStore()</code> 这种方式，只是使用了 <code>useStore()</code> 的 <code>dispatch</code> 方法，React 的机制是只要有组件调用了 <code>useStore()</code> 钩子，<code>state</code> 变化时此组件都会重绘，和是否使用 <code>state</code> 没有关系，这样我们的很多只引用了 <code>dispatch</code> 方法的组件都会执行重绘，引用的组件越多重绘计算就变得越是非常的浪费，那怎么解决呢？</p><h3 id="减少不必要的组件重绘"><a href="#减少不必要的组件重绘" class="headerlink" title="减少不必要的组件重绘"></a>减少不必要的组件重绘</h3><p><code>useStore()</code> 方法是我们为了方便调用封装的一个钩子，它的背后执行的是 <code>useContext(Context)</code>，也就是每当 <code>&lt;Context.Provider value={[state, dispatch]} /&gt;</code> 的 <code>value</code> 变化时，就会重绘对应引用 <code>useContext(Context)</code> 钩子的组件，知道了原因接下来就是解决问题了。</p><p>既然 <code>[state, dispatch]</code> 并不一定会一块使用，但会一块更新，那我们就把 <code>&lt;Context.Provider value={[state, dispatch]} /&gt;</code> 拆分成两个 <code>Context</code> 就能解决此问题，一个 <code>&lt;StateContext.Provider value={state} /&gt;</code>，另一个为 <code>&lt;DispatchContext.Provider value={dispatch} /&gt;</code>，然后分别封装 <code>useStateStore()</code> 与 <code>useDispatchStore()</code> 钩子，这样的话 <code>state</code> 变动时只调用 <code>useDispatchStore()</code> 钩子的组件并不会做多余的重绘，具体优化如下。</p><p>编辑 <code>store.jsx</code> 文件。</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">    import React, &#123; createContext, useReducer, useContext &#125; from 'react';</span><br><span class="line"></span><br><span class="line">    const initialState = &#123;count: 0&#125;;</span><br><span class="line"></span><br><span class="line">    function reducer(state, action) &#123;</span><br><span class="line">      switch (action.type) &#123;</span><br><span class="line">        case 'increment':</span><br><span class="line">          return &#123;count: state.count + 1&#125;;</span><br><span class="line">        case 'decrement':</span><br><span class="line">          return &#123;count: state.count - 1&#125;;</span><br><span class="line">        default:</span><br><span class="line">          throw new Error();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="deletion">-   const Context = createContext();</span></span><br><span class="line"></span><br><span class="line"><span class="deletion">-   function useStore() &#123;</span></span><br><span class="line"><span class="deletion">-     return useContext(Context);</span></span><br><span class="line"><span class="deletion">-   &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+   const StateContext = createContext();</span></span><br><span class="line"><span class="addition">+   const DispatchContext = createContext();</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+   function useStateStore() &#123;</span></span><br><span class="line"><span class="addition">+     return useContext(StateContext);</span></span><br><span class="line"><span class="addition">+   &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+   function useDispatchStore() &#123;</span></span><br><span class="line"><span class="addition">+     return useContext(DispatchContext);</span></span><br><span class="line"><span class="addition">+   &#125;</span></span><br><span class="line"></span><br><span class="line">    function StoreProvider(&#123; children &#125;) &#123;</span><br><span class="line">      const [state, dispatch] = useReducer(reducer, initialState);</span><br><span class="line"></span><br><span class="line">      return (</span><br><span class="line"><span class="deletion">-       &lt;Context.Provider value=&#123;[state, dispatch]&#125;&gt;</span></span><br><span class="line"><span class="deletion">-         &#123;children&#125;</span></span><br><span class="line"><span class="deletion">-       &lt;/Context.Provider&gt;</span></span><br><span class="line"><span class="addition">+       &lt;StateContext.Provider value=&#123;state&#125;&gt;</span></span><br><span class="line"><span class="addition">+         &lt;DispatchContext.Provider value=&#123;dispatch&#125;&gt;</span></span><br><span class="line"><span class="addition">+           &#123;children&#125;</span></span><br><span class="line"><span class="addition">+         &lt;/DispatchContext.Provider&gt;</span></span><br><span class="line"><span class="addition">+       &lt;/StateContext.Provider&gt;</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="deletion">-   export &#123; useStore, StoreProvider &#125;;</span></span><br><span class="line"><span class="addition">+   export &#123; useStateStore, useDispatchStore, StoreProvider &#125;;</span></span><br></pre></td></tr></table></figure><p>修改 <code>Header.jsx</code> 文件，只调用 <code>useDispatchStore()</code> 钩子。</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    import React from 'react';</span><br><span class="line"><span class="deletion">-   import &#123; useStore &#125; from './store';</span></span><br><span class="line"><span class="addition">+   import &#123; useDispatchStore &#125; from './store';</span></span><br><span class="line"></span><br><span class="line">    function Header() &#123;</span><br><span class="line"><span class="deletion">-     const [/* state */, dispatch] = useStore();</span></span><br><span class="line"><span class="addition">+     const dispatch = useDispatchStore();</span></span><br><span class="line">      console.log('header udpate');</span><br><span class="line"></span><br><span class="line">      return (</span><br><span class="line">        &lt;&gt;</span><br><span class="line">          &lt;button onClick=&#123;() =&gt; dispatch(&#123;type: 'decrement'&#125;)&#125;&gt;-&lt;/button&gt;</span><br><span class="line">          &lt;button onClick=&#123;() =&gt; dispatch(&#123;type: 'increment'&#125;)&#125;&gt;+&lt;/button&gt;</span><br><span class="line">        &lt;/&gt;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    export default Header;</span><br></pre></td></tr></table></figure><p>修改 <code>Footer.jsx</code> 文件，只调用 <code>useStateStore()</code> 钩子。</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    import React from 'react';</span><br><span class="line"><span class="deletion">-   import &#123; useStore &#125; from './store';</span></span><br><span class="line"><span class="addition">+   import &#123; useStateStore &#125; from './store';</span></span><br><span class="line"></span><br><span class="line">    function Footer() &#123;</span><br><span class="line"><span class="deletion">-     const [state] = useStore();</span></span><br><span class="line"><span class="addition">+     const state = useStateStore();</span></span><br><span class="line">      console.log('footer udpate');</span><br><span class="line"></span><br><span class="line">      return (</span><br><span class="line">        &lt;p&gt;&#123;state.count&#125;&lt;/p&gt;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    export default Footer;</span><br></pre></td></tr></table></figure><p>当我们再次运行时点击 <code>+</code>、<code>-</code> 按钮只会重绘引用 <code>useStateStore()</code> 的组件，而引用 <code>useDispatchStore()</code> 的组件则不会跟随重绘，效果如下。</p><iframe src="https://codesandbox.io/embed/state-management-and-performance-optimization-for-react-m26tf?expanddevtools=1&fontsize=14&hidenavigation=1&theme=dark" width="100%" height="500" frameborder="0" loading="lazy" allowfullscreen></iframe><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>如果你们的项目直接使用 Context 和 Hooks 实现全局状态管理的话可以试下这个优化点，在实际开发中能为我们省下无数根头发。</p><p>至此结束，感谢阅读。</p></section></article><div class="comments"><div id="comments"></div><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>new Gitalk({clientID:"2f728eb14f7e549408f7",clientSecret:"90be74e913959dcf39fbfed54458bdd20f95ac30",repo:"sanonz.github.io",owner:"sanonz",admin:["sanonz"],id:"694a8f65977472c910a7c3c76f06b02a",distractionFreeMode:!0,title:"使用 React Context API 和 Hooks 实现全局状态管理和性能优化",body:"https://sanonz.github.io/2020/state-management-and-performance-optimization-for-react-context-api-with-hooks/",labels:["React.js"]}).render("comments")</script></div></div></div><a id="pagenext" href="/2020/make-hybrid-platform-cordova/" class="article-next" title="使用 Phonegap + Cordova 搭建混合开发平台"><i class="icon-arrow-right"></i></a> <a id="pageprev" href="/2021/use-fontcreator-to-edit-font-libraries/" class="article-prev" title="使用 FontCreator 编辑字体库"><i class="icon-arrow-left"></i></a><footer class="footer">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e4027971a230b210f4671f485b33846a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></footer></main><script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script><script type="text/javascript">$(function(){var n={nav:$("#nav"),aside:$("#aside"),asideInner:$("#aside-inner"),navInner:$("#nav-inner")},e=!1;function i(){"none"!==n.navInner.css("display")&&n.navInner.css("display","")}n.asideInner.on("webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend",function(){n.aside.hasClass("mobile-open")?n.aside.removeClass("mobile-open"):n.aside.removeClass("mobile-close panel-show"),e=!1}),$("#open-panel, #aside-mask").on("click",function(){e||(n.aside.hasClass("panel-show")?n.aside.addClass("mobile-close"):n.aside.addClass("mobile-open panel-show"))}),$("#open-menus").on("click",function(){n.navInner.slideToggle("normal",i)}),window.innerWidth<=960&&setTimeout(function(){n.navInner.slideUp("normal",i)},3e3),$(window).on("resize",function(){960<$(this).width()&&n.navInner.css("display","")})})</script><script src="/js/scrollspy.min.js"></script><script type="text/javascript">$(document.body).scrollspy({target:"#aside-inner"}),$(window).on("resize",function(){var e=$("#header").width(),t=$("#wrapper").width(),i=($(this).width()-e-t)/2/2,r=$("#pageprev"),d=$("#pagenext"),s=(r.width()+d.width())/2;if(s<i){var n=i-s/2,o={position:"fixed",top:"50%",marginTop:-(r.width()+d.width())/4};r.css($.extend({left:e+n},o)),d.css($.extend({right:n},o))}else r.removeAttr("style"),d.removeAttr("style")}).trigger("resize")</script></body></html>